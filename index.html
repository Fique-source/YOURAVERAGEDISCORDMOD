<html><head><base href=".">
    <meta charset="UTF-8">
    <title>Escape from P. Diddy!</title>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&amp;display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Creepster', cursive;
        }
        #game-container {
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to bottom, #3c1255, #000000); /* Darkened for evil effect */
        }
        .ui-element {
            position: fixed;
            color: #DA70D6; /* Lavender</>. */
            font-family: 'Creepster', cursive;
            text-shadow: 2px 2px 2px rgba(0, 0, 0, 0.8);
        }
        .menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('crazy downfall.webp');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: rgba(0, 0, 0, 0.7); /* Darkened overlay */
            background-blend-mode: multiply;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #game-over.menu {
            background-image: none;
            background-color: rgba(0, 0, 0, 0.7);
        }
        #pause-menu.menu {
            background-image: none;
            background-color: rgba(0, 0, 0, 0.7);
        }
        .menu button {
            padding: 15px 30px;
            font-size: 24px;
            margin: 10px;
            cursor: pointer;
            background: #8B0000; /* Dark red button */
            border: none;
            color: #FFD700;
            border-radius: 5px;
            transition: transform 0.2s, background-color 0.3s;
            box-shadow: 0 0 15px #8B0000;
        }
        .menu button:hover {
            transform: scale(1.1);
            background-color: #990000;
        }
        .evil-mode-btn {
            background: #330000 !important;
            color: #ff0000 !important;
            text-shadow: 0 0 10px #ff0000 !important;
            box-shadow: 0 0 15px #ff0000 !important;
        }

        .evil-mode-btn:hover {
            background: #660000 !important;
        }

        .practice-mode-btn {
            background: #006400 !important;
            color: #90EE90 !important;
            text-shadow: 0 0 10px #90EE90 !important;
            box-shadow: 0 0 15px #006400 !important;
        }

        .practice-mode-btn:hover {
            background: #008000 !important;
        }
        .menu h1 {
            color: #DA70D6;
            font-size: 48px;
            margin-bottom: 30px;
            font-family: 'Creepster', cursive;
        }
        #game-over,
        #victory-screen,
        #pause-menu,
        #settings-menu,
        #tutorial-menu {
            display: none;
        }
        #start-menu {
            display: flex;
        }
        .jumpscare {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1.5); 
            font-size: 60px; 
            color: red;
            animation: shake 0.1s infinite;
        }
        @keyframes shake {
            0% { transform: translate(-50%, -50%) scale(1.5) rotate(0deg); }
            25% { transform: translate(-52%, -48%) scale(1.5) rotate(5deg); }
            75% { transform: translate(-48%, -52%) scale(1.5) rotate(-5deg); }
            100% { transform: translate(-50%, -50%) scale(1.5) rotate(0deg); }
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            color: #DA70D6;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            font-size: 32px;
            font-family: 'Creepster', cursive;
            flex-direction: column;  
        }

        .loading button {
            padding: 15px 30px;
            font-size: 24px;
            margin: 10px;
            cursor: pointer;
            background: #8B0000;
            border: none;
            color: #FFD700;
            border-radius: 5px;
            transition: transform 0.2s, background-color 0.3s;
            box-shadow: 0 0 15px #8B0000;
        }

        .loading button:hover {
            transform: scale(1.1);
            background-color: #990000;
        }
        #stamina-bar, #battery-bar {
            position: fixed;
            bottom: 20px;
            width: 200px;
            height: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #FFD700;
        }
        #stamina-fill, #battery-fill {
            width: 100%;
            height: 100%;
            transition: width 0.3s;
        }
        #stamina-bar {
            left: 20px;
        }
        #battery-bar {
            left: 240px;
        }
        #stamina-fill {
            background: linear-gradient(90deg, #a40000, #d40000);
        }
        #battery-fill {
            background: linear-gradient(90deg, #00008B, #0000FF);
        }
        #stamina-percentage {
            position: fixed;
            bottom: 42px;
            left: 20px;
            color: #FFD700;
            font-family: 'Creepster', cursive;
            text-shadow: 2px 2px 2px rgba(0,0,0,0.8);
        }
        #battery-percentage {
            position: fixed;
            bottom: 42px;
            left: 240px;
            color: #FFD700;
            font-family: 'Creepster', cursive;
            text-shadow: 2px 2px 2px rgba(0,0,0,0.8);
        }
        #lotion-counter, #battery-indicator, #controls {
            font-size: 20px;
        }
        #lotion-counter {
            position: fixed;
            top: 230px;
            right: 20px;
            color: #FFD700;
        }
        #minimap {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 200px;
            background: rgba(0,0,0,0.8);
            border: 2px solid #FFD700;
            overflow: hidden;
        }
        #static-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0;
            transition: opacity 0.3s;
            mix-blend-mode: screen;
            z-index: 999;
            animation: glitch 0.2s infinite;
        }

        @keyframes glitch {
            0% { transform: translate(0) skew(0); filter: blur(0); }
            20% { transform: translate(-2px, 2px) skew(2deg); filter: blur(1px); }
            40% { transform: translate(2px, -2px) skew(-2deg); filter: blur(0); }
            60% { transform: translate(-2px) skew(0); filter: blur(2px); }
            80% { transform: translate(2px) skew(2deg); filter: blur(0); }
            100% { transform: translate(0) skew(0); filter: blur(0); }
        }
        .ui-element, #battery-indicator {
            font-family: 'Creepster', cursive;
        }
        #controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: #FFD700;
        }
        #flashlight-state {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #FFD700;
            font-family: 'Creepster', cursive;
            text-shadow: 2px 2px 2px rgba(0,0,0,0.8);
        }
        #diddler-state {
            position: fixed;
            top: 50px; 
            left: 20px;
            color: #FFD700;
            font-family: 'Creepster', cursive;
            text-shadow: 2px 2px 2px rgba(0,0,0,0.8);
        }
        #version-number {
            position: fixed;
            bottom: 10px;
            left: 10px;
            color: #666666;
            font-family: Arial, sans-serif;
            font-size: 12px;
            z-index: 1001;
        }
        #jumpscare-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('scary445.webp');
            background-size: cover;
            background-position: center;
            opacity: 0;
            pointer-events: none;
            z-index: 1002;
            transition: opacity 3s; 
        }
        .evil-mode {
          filter: hue-rotate(180deg) saturate(200%) contrast(150%);
        }

        .evil-mode #game-container {
          background: linear-gradient(to bottom, #660000, #000000);
        }

        .evil-mode .menu {
          background-color: rgba(100, 0, 0, 0.7);
        }

        .evil-mode #static-overlay {
          opacity: 0.4 !important;
          background-color: rgba(255, 0, 0, 0.1);
          mix-blend-mode: multiply;
        }
        #tutorial-menu ul {
            margin: 10px 0;
        }
        #tutorial-menu li {
            margin: 5px 0;
        }
        #tutorial-menu p {
            margin: 15px 0;
        }
        #difficulty-menu.menu button {
            padding: 15px 30px;
            font-size: 24px;
            margin: 10px;
            cursor: pointer;
            background: #8B0000;
            border: none;
            color: #FFD700;
            border-radius: 5px;
            transition: transform 0.2s, background-color 0.3s;
            box-shadow: 0 0 15px #8B0000;
        }
        #collection-message {
            position: fixed;
            top: 20px;  
            left: 50%;
            transform: translate(-50%, 0);  
            font-family: 'Creepster', cursive;
            font-size: 32px;
            opacity: 0;
            transition: opacity 2s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 1000;
            pointer-events: none;
        }
        #collection-message.battery-message {
            color: #FFD700; /* Yellow for battery messages */
        }

        #collection-message.oil-message {
            color: #00BFFF; /* Blue for oil messages */
        }
        .settings-option {
            color: #FFD700;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .jumpscare-setting {
            color: #ff0000 !important;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { text-shadow: 0 0 10px #ff0000; }
            50% { text-shadow: 0 0 20px #ff0000; }
            100% { text-shadow: 0 0 10px #ff0000; }
        }
    </style>
</head>
<body>
    <div id="difficulty-menu" class="menu" style="display: none;">
        <h1>Select Difficulty</h1>
        <button class="practice-mode-btn" onclick="playButtonClickSound(); startGameWithDifficulty(&apos;practice&apos;)">Practice Mode</button>
        <button onclick="playButtonClickSound(); startGameWithDifficulty(&apos;normal&apos;)">Normal Mode</button>
        <button class="evil-mode-btn" onclick="playButtonClickSound(); startGameWithDifficulty(&apos;evil&apos;)">Evil Mode</button>
        <button onclick="playButtonClickSound(); showTitleMenu()">Back</button>
    </div>
    <div id="game-container"></div>
    <div id="stamina-bar"><div id="stamina-fill"></div></div>
    <div id="stamina-percentage">100%</div>
    <div id="battery-bar"><div id="battery-fill"></div></div>
    <div id="battery-percentage">100%</div>
    <div class="ui-element" id="lotion-counter">Baby Oil: 0/26</div>
    <div class="ui-element" id="flashlight-state">Flashlight: false</div>
    <div class="ui-element" id="diddler-state">Diddler Mode: false</div>
    <div class="ui-element" id="controls">
        Controls:<br>
        WASD - Move<br>
        Shift - Sprint<br>
        &#x2190;&#x2192; - Rotate Camera<br>
        F - Toggle Flashlight
    </div>
    <div class="loading ui-element">
        Loading Escape from P. Diddy...
        <button id="loading-complete-btn" style="display: none; margin-top: 20px; padding: 10px 20px;">Okay</button>
    </div>
    <audio id="jumpscare-sound" preload="auto">
        <source src="jumpscare_long.mp3" type="audio/mpeg">
    </audio>
    <audio id="chase-music" loop preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/123/123-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="menu-theme" loop>
        <source src="menu theme.mp3" type="audio/mpeg">
    </audio>
    <audio id="button-click-sound" preload="auto">
        <source src="analog-appliance-button-15-186961.mp3" type="audio/mpeg">
    </audio>
    <audio id="walking-sound" loop>
        <source src="414333__unlistenable__walking_2.wav" type="audio/wav">
    </audio>
    <audio id="flashlight-click-sound" preload="auto">
        <source src="flashlight-clicking-on-105809.mp3" type="audio/mpeg">
    </audio>
    <div id="start-menu" class="menu">
        <h1>Escape from P. Diddy</h1>
        <button onclick="playButtonClickSound(); showDifficultyMenu()">Start Game</button>
        <button onclick="playButtonClickSound(); showSettings()">Settings</button>
        <button onclick="playButtonClickSound(); showTutorial()">How to Play</button>
    </div>

    <div id="game-over" class="menu">
        <div class="jumpscare">&#x1f435; YOU GOT DIDDLED... &#x1f435;</div>
        <div style="flex-grow: 1"></div>
        <button onclick="playButtonClickSound(); restartGame()">Play Again</button>
        <button onclick="playButtonClickSound(); showTitleMenu()">Return to Title</button>
    </div>

    <div id="victory-screen" class="menu">
        <h1>Victory!</h1>
        <p style="color: #FFD700; font-size: 24px;">You&apos;ve collected all the baby oil and escaped Diddy!</p>
        <button onclick="playButtonClickSound(); restartGame()">Play Again</button>
        <button onclick="playButtonClickSound(); showTitleMenu()">Return to Title</button>
    </div>
    <div id="minimap"></div>
    <div id="static-overlay"></div>
    <div id="pause-menu" class="menu">
        <h1>Pause Menu</h1>
        <button onclick="playButtonClickSound(); togglePause()">Continue</button>
        <button onclick="playButtonClickSound(); showTitleMenu()">Quit to Title</button>
    </div>
    <div id="settings-menu" class="menu" style="display: none;">
        <h1>Settings</h1>
        <div class="settings-option">
            <label>
                RELEASE THE DIDDLER:
                <input type="checkbox" id="use-jamal-model">
            </label>
        </div>
        <div class="settings-option">
            <label>
                Use Mouse Look:
                <input type="checkbox" id="use-mouse-look" onchange="toggleMouseLook(this.checked)">
            </label>
        </div>
        <div class="settings-option">
            <label class="jumpscare-setting">
                Jumpscare?
                <input type="checkbox" id="enable-jumpscare">
            </label>
        </div>
        <button onclick="playButtonClickSound(); closeSettings()">Back</button>
    </div>
    <div id="tutorial-menu" class="menu" style="display: none;">
        <h1>How to Play</h1>
        <div style="color: #FFD700; font-size: 24px; text-align: center; margin: 20px;">
            <p>You must collect 26 bottles of baby oil while avoiding P. Diddy!</p>
            
            <p>Controls:</p>
            <ul style="list-style: none; padding: 0;">
                <li>WASD - Move around</li>
                <li>Shift - Sprint (uses stamina)</li>
                <li>Arrow Keys - Look around</li>
                <li>F - Toggle flashlight</li>
                <li>Q - Pause game</li>
            </ul>
            
            <p>Tips:</p>
            <ul style="list-style: none; padding: 0;">
                <li>Collect batteries to restore flashlight power and stamina</li>
                <li>P. Diddy moves faster when your flashlight is off</li>
                <li>Baby oil restores some stamina and battery power</li>
                <li>Evil mode makes P. Diddy much faster!</li>
            </ul>
        </div>
        <button onclick="playButtonClickSound(); closeTutorial()">Back</button>
    </div>
    <div id="version-number">v3.3.4 Public Beta - Subb Engine</div>
    <div id="jumpscare-overlay"></div>
    <div id="collection-message"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>const obstacles = new Set();
const trees = new Set();
let fenceMeshes = new Set();
const chunkSize = 100;
const renderDistance = 1;
let lastUpdate = performance.now();
let frameCount = 0;
let minimapGeometries = null;
let minimapMaterials = null;
let gameActive = false;
let gameOver = false;
let isPaused = false;
let mouseSensitivity = 0.009 / 2;
const normalBaseSpeed = 0.2;
const evilBaseSpeed = 0.35;
let isPracticeMode = false;
const arrowKeyRotationSpeed = 0.09 / 2;
const player = {
  speed: 0.3,
  sprintSpeed: 0.6,
  exhaustedSpeed: 0.15,
  stamina: 100,
  position: new THREE.Vector3(0, 2, 20),
  rotationSpeed: mouseSensitivity,
  flashlightOn: false,
  batteryLevel: 100
};
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);
scene.fog = new THREE.FogExp2(0x000000, 0.05);
const grassTexture = new THREE.TextureLoader().load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/terrain/grasslight-big.jpg');
grassTexture.wrapS = grassTexture.wrapT = THREE.RepeatWrapping;
grassTexture.repeat.set(50, 50);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.getElementById('game-container').appendChild(renderer.domElement);
const ambientLight = new THREE.AmbientLight(0x202020);
scene.add(ambientLight);
const directionalLight = new THREE.DirectionalLight(0xffffff, 0.2);
directionalLight.position.set(5, 5, 5);
scene.add(directionalLight);
const flashlight = new THREE.SpotLight(0xFFFFFF, 2);
flashlight.angle = Math.PI / 4;
flashlight.penumbra = 0.2;
flashlight.decay = 1;
flashlight.distance = 30;
flashlight.intensity = 3;
scene.add(flashlight);
const chaseMusic = document.getElementById('chase-music');
const diddyLight = new THREE.PointLight(0xff0000, 1, 5);
const batteryPacks = new Set();
let useJamalModel = false;
const jamalTexture = new THREE.TextureLoader().load('jamal enocada.jpeg');
function createBatteryPack(x, z) {
  const distance = Math.sqrt(x * x + z * z);
  if (distance > fenceRadius - 5 || distance < 10) {
    const angle = Math.atan2(z, x);
    x = Math.cos(angle) * (fenceRadius - 5);
    z = Math.sin(angle) * (fenceRadius - 5);
  }
  const battery = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 0.5), new THREE.MeshPhongMaterial({
    color: 0xFFD700
  }));
  battery.position.set(x, 0.5, z);
  scene.add(battery);
  batteryPacks.add(battery);
  return battery;
}
function initializeBatteries() {
  batteryPacks.forEach(battery => {
    scene.remove(battery);
  });
  batteryPacks.clear();
  while (batteryPacks.size < 8) {
    const radius = Math.random() * (fenceRadius - 25) + 20;
    const angle = Math.random() * Math.PI * 2;
    createBatteryPack(Math.cos(angle) * radius, Math.sin(angle) * radius);
  }
}
function startGame() {
  document.getElementById('start-menu').style.display = 'none';
  document.getElementById('difficulty-menu').style.display = 'flex';
}
function startGameWithDifficulty(mode) {
  isPracticeMode = mode === 'practice';
  isEvilMode = mode === 'evil';
  if (isEvilMode) {
    document.body.classList.add('evil-mode');
  } else {
    document.body.classList.remove('evil-mode');
  }
  if (isPracticeMode) {
    document.getElementById('game-container').classList.add('practice-mode-lighting');
  } else {
    document.getElementById('game-container').classList.remove('practice-mode-lighting');
  }
  document.getElementById('difficulty-menu').style.display = 'none';
  gameActive = true;
  useJamalModel = document.getElementById('use-jamal-model').checked;
  document.getElementById('diddler-state').textContent = `Diddler Mode: ${useJamalModel ? 'true' : 'false'}`;
  gameOver = false;
  isPaused = false;
  player.position.set(0, 2, 20);
  player.stamina = 100;
  player.batteryLevel = 100;
  player.flashlightOn = false;
  diddy.visible = false;
  const spawnAngle = Math.random() * Math.PI * 2;
  const minDistance = 50;
  const maxDistance = fenceRadius - 10;
  const spawnDistance = Math.random() * (maxDistance - minDistance) + minDistance;
  const spawnX = Math.cos(spawnAngle) * spawnDistance;
  const spawnZ = Math.sin(spawnAngle) * spawnDistance;
  diddy.position.set(spawnX, 0, spawnZ);
  flashlight.visible = false;
  lotions.forEach(lotion => {
    scene.remove(lotion);
  });
  lotions.clear();
  lotionsCollected = 0;
  for (let i = 0; i < 26; i++) {
    const radius = Math.random() * (fenceRadius - 25) + 20;
    const angle = Math.random() * Math.PI * 2;
    createLotion(Math.cos(angle) * radius, Math.sin(angle) * radius);
  }
  document.getElementById('lotion-counter').textContent = `Baby Oil: ${lotionsCollected}/26`;
  initializeBatteries();
  updateStaminaBar();
  updateBatteryBar();
  const walkingSound = document.getElementById('walking-sound');
  walkingSound.volume = 0.5;
  walkingSound.playbackRate = 1.0;
  const jumpscareSound = document.getElementById('jumpscare-sound');
  jumpscareSound.pause();
  jumpscareSound.currentTime = 0;
  menuTheme.pause();
  menuTheme.currentTime = 0;
  chaseMusic.volume = 0;
  chaseMusic.play().catch(error => console.log("Audio play failed:", error));
  player.rotationSpeed = mouseSensitivity;
}
function restartGame() {
  if (!gameOver) return;
  if (isEvilMode) {
    document.body.classList.add('evil-mode');
  } else {
    document.body.classList.remove('evil-mode');
  }
  if (isPracticeMode) {
    document.getElementById('game-container').classList.add('practice-mode-lighting');
  } else {
    document.getElementById('game-container').classList.remove('practice-mode-lighting');
  }
  document.getElementById('game-over').style.display = 'none';
  document.getElementById('victory-screen').style.display = 'none';
  menuTheme.pause();
  menuTheme.currentTime = 0;
  useJamalModel = document.getElementById('use-jamal-model').checked;
  document.getElementById('diddler-state').textContent = `Diddler Mode: ${useJamalModel ? 'true' : 'false'}`;
  gameOver = false;
  gameActive = true;
  isPaused = false;
  player.position.set(0, 2, 20);
  player.stamina = 100;
  player.batteryLevel = 100;
  player.flashlightOn = false;
  diddy.visible = false;
  const spawnAngle = Math.random() * Math.PI * 2;
  const minDistance = 50;
  const maxDistance = fenceRadius - 10;
  const spawnDistance = Math.random() * (maxDistance - minDistance) + minDistance;
  const spawnX = Math.cos(spawnAngle) * spawnDistance;
  const spawnZ = Math.sin(spawnAngle) * spawnDistance;
  diddy.position.set(spawnX, 0, spawnZ);
  flashlight.visible = false;
  lotions.forEach(lotion => {
    scene.remove(lotion);
  });
  lotions.clear();
  lotionsCollected = 0;
  for (let i = 0; i < 26; i++) {
    const radius = Math.random() * (fenceRadius - 25) + 20;
    const angle = Math.random() * Math.PI * 2;
    createLotion(Math.cos(angle) * radius, Math.sin(angle) * radius);
  }
  document.getElementById('lotion-counter').textContent = `Baby Oil: ${lotionsCollected}/26`;
  initializeBatteries();
  updateStaminaBar();
  updateBatteryBar();
  const jumpscareSound = document.getElementById('jumpscare-sound');
  jumpscareSound.pause();
  jumpscareSound.currentTime = 0;
  menuTheme.pause();
  menuTheme.currentTime = 0;
  chaseMusic.volume = 0;
  chaseMusic.play().catch(error => console.log("Audio play failed:", error));
  player.rotationSpeed = mouseSensitivity;
}
let lotionsCollected = 0;
const lotions = new Set();
const fenceGeometry = new THREE.BoxGeometry(1, 4, 1);
const fenceMaterial = new THREE.MeshPhongMaterial({
  color: 0x8B4513
});
const fenceRadius = 150;
const fenceCount = 200;
for (let i = 0; i < fenceCount; i++) {
  const angle = i / fenceCount * Math.PI * 2;
  const nextAngle = (i + 1) / fenceCount * Math.PI * 2;
  const wallStart = new THREE.Vector2(Math.cos(angle) * fenceRadius, Math.sin(angle) * fenceRadius);
  const wallEnd = new THREE.Vector2(Math.cos(nextAngle) * fenceRadius, Math.sin(nextAngle) * fenceRadius);
  const fenceSegment = new THREE.Mesh(fenceGeometry, fenceMaterial);
  fenceSegment.position.set((wallStart.x + wallEnd.x) / 2, 2, (wallStart.y + wallEnd.y) / 2);
  fenceSegment.lookAt(wallEnd.x, 2, wallEnd.y);
  scene.add(fenceSegment);
  fenceMeshes.add(fenceSegment);
  obstacles.add({
    type: 'wall',
    start: wallStart,
    end: wallEnd
  });
}
function createTree(x, z) {
  const distance = Math.sqrt(x * x + z * z);
  if (distance > fenceRadius - 5 || distance < 10) {
    const angle = Math.atan2(z, x);
    x = Math.cos(angle) * (fenceRadius - 5);
    z = Math.sin(angle) * (fenceRadius - 5);
  }
  const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 5), new THREE.MeshPhongMaterial({
    color: 0x8B4513
  }));
  const leaves = new THREE.Mesh(new THREE.SphereGeometry(2.5), new THREE.MeshPhongMaterial({
    color: 0x228B22
  }));
  leaves.position.y = 3.5;
  const tree = new THREE.Group();
  tree.add(trunk);
  tree.add(leaves);
  tree.position.set(x, 2.5, z);
  scene.add(tree);
  trees.add(tree);
  return tree;
}
for (let i = 0; i < 100; i++) {
  const radius = Math.random() * (fenceRadius - 25) + 20;
  const angle = Math.random() * Math.PI * 2;
  createTree(Math.cos(angle) * radius, Math.sin(angle) * radius);
}
function createLotion(x, z) {
  const distance = Math.sqrt(x * x + z * z);
  if (distance > fenceRadius - 5 || distance < 10) {
    const angle = Math.atan2(z, x);
    x = Math.cos(angle) * (fenceRadius - 5);
    z = Math.sin(angle) * (fenceRadius - 5);
  }
  const bottle = new THREE.Group();
  const body = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 0.8), new THREE.MeshPhongMaterial({
    color: 0x87CEFA,
    transparent: true,
    opacity: 0.6,
    shininess: 100,
    specular: 0xffffff
  }));
  const cap = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 0.2), new THREE.MeshPhongMaterial({
    color: 0x4169E1,
    shininess: 100,
    specular: 0xffffff
  }));
  const bottleLight = new THREE.PointLight(0x87CEFA, 2, 5);
  bottleLight.position.set(0, 0.5, 0);
  cap.position.y = 0.5;
  bottle.add(body);
  bottle.add(cap);
  bottle.add(bottleLight);
  bottle.position.set(x, 1, z);
  scene.add(bottle);
  lotions.add(bottle);
  return bottle;
}
for (let i = 0; i < 26; i++) {
  const radius = Math.random() * (fenceRadius - 25) + 20;
  const angle = Math.random() * Math.PI * 2;
  createLotion(Math.cos(angle) * radius, Math.sin(angle) * radius);
}
function createTerrainChunk(x, z) {
  const chunk = new THREE.Group();
  const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshPhongMaterial({
    map: grassTexture,
    color: 0xAAAAAA
  }));
  floor.rotation.x = -Math.PI / 2;
  floor.position.set(x, 0, z);
  chunk.add(floor);
  return chunk;
}
const chunks = new Map();
function updateMinimap() {
  const minimapScene = new THREE.Scene();
  minimapScene.background = new THREE.Color(0x000000);
  if (!minimapGeometries) {
    minimapGeometries = {
      dot: new THREE.CircleGeometry(2.5, 16),
      lotionDot: new THREE.CircleGeometry(2.5, 16),
      treeDot: new THREE.CircleGeometry(2.5, 16)
    };
    minimapMaterials = {
      player: new THREE.MeshBasicMaterial({
        color: 0xFFFFFF,
        side: THREE.DoubleSide
      }),
      diddy: new THREE.MeshBasicMaterial({
        color: 0xFF0000,
        side: THREE.DoubleSide
      }),
      lotion: new THREE.MeshBasicMaterial({
        color: 0x00FFFF,
        side: THREE.DoubleSide
      }),
      tree: new THREE.MeshBasicMaterial({
        color: 0x228B22,
        side: THREE.DoubleSide
      })
    };
  }
  minimapCamera.position.set(player.position.x, 100, player.position.z);
  minimapCamera.lookAt(player.position.x, 0, player.position.z);
  const playerMarker = new THREE.Mesh(minimapGeometries.dot, minimapMaterials.player);
  playerMarker.rotation.x = -Math.PI / 2;
  playerMarker.position.set(player.position.x, 1, player.position.z);
  minimapScene.add(playerMarker);
  const diddyDot = new THREE.Mesh(minimapGeometries.dot, minimapMaterials.diddy);
  diddyDot.rotation.x = -Math.PI / 2;
  diddyDot.position.set(diddy.position.x, 1, diddy.position.z);
  diddyDot.visible = player.flashlightOn;
  minimapScene.add(diddyDot);
  fenceMeshes.forEach(fence => {
    const fenceLine = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshBasicMaterial({
      color: 0x8B4513
    }));
    fenceLine.position.copy(fence.position);
    fenceLine.rotation.copy(fence.rotation);
    minimapScene.add(fenceLine);
  });
  lotions.forEach(lotion => {
    const lotionDot = new THREE.Mesh(minimapGeometries.lotionDot, minimapMaterials.lotion);
    lotionDot.rotation.x = -Math.PI / 2;
    lotionDot.position.set(lotion.position.x, 1, lotion.position.z);
    minimapScene.add(lotionDot);
  });
  trees.forEach(tree => {
    const treeDot = new THREE.Mesh(minimapGeometries.treeDot, minimapMaterials.tree);
    treeDot.rotation.x = -Math.PI / 2;
    treeDot.position.set(tree.position.x, 1, tree.position.z);
    minimapScene.add(treeDot);
  });
  const gridHelper = new THREE.GridHelper(1000, 100, 0x444444, 0x444444);
  minimapScene.add(gridHelper);
  minimapRenderer.render(minimapScene, minimapCamera);
}
function updateTerrain() {
  const playerChunkX = Math.floor(player.position.x / chunkSize);
  const playerChunkZ = Math.floor(player.position.z / chunkSize);
  for (const [key, chunk] of chunks) {
    const [x, z] = key.split(',').map(Number);
    if (Math.abs(x - playerChunkX) > renderDistance || Math.abs(z - playerChunkZ) > renderDistance) {
      scene.remove(chunk);
      chunks.delete(key);
    }
  }
  for (let x = playerChunkX - renderDistance; x <= playerChunkX + renderDistance; x++) {
    for (let z = playerChunkZ - renderDistance; z <= playerChunkZ + renderDistance; z++) {
      const key = `${x},${z}`;
      if (!chunks.has(key)) {
        const chunk = createTerrainChunk(x * chunkSize, z * chunkSize);
        scene.add(chunk);
        chunks.set(key, chunk);
      }
    }
  }
}
const diddy = new THREE.Group();
diddy.visible = false;
diddy.position.set(100, 0, 100);
diddy.add(diddyLight);
const body = new THREE.Mesh(new THREE.SphereGeometry(1), new THREE.MeshPhongMaterial({
  color: 0x8B4513
}));
diddy.add(body);
const face = new THREE.Mesh(new THREE.SphereGeometry(0.6), new THREE.MeshPhongMaterial({
  color: 0xFFA07A
}));
face.position.z = 0.5;
diddy.add(face);
const leftEye = new THREE.Mesh(new THREE.CircleGeometry(0.1), new THREE.MeshPhongMaterial({
  color: 0x000000
}));
leftEye.position.set(-0.2, 0.1, 1);
leftEye.rotation.y = Math.PI / 2;
diddy.add(leftEye);
const rightEye = new THREE.Mesh(new THREE.CircleGeometry(0.1), new THREE.MeshPhongMaterial({
  color: 0x000000
}));
rightEye.position.set(0.2, 0.1, 1);
rightEye.rotation.y = Math.PI / 2;
diddy.add(rightEye);
for (let i = 0; i < 8; i++) {
  const angle = Math.PI / 8 * i - Math.PI / 2;
  const smilePart = new THREE.Mesh(new THREE.SphereGeometry(0.05), new THREE.MeshPhongMaterial({
    color: 0x000000
  }));
  smilePart.position.set(Math.cos(angle) * 0.3, Math.sin(angle) * 0.2 - 0.1, 1);
  diddy.add(smilePart);
}
const leftEar = new THREE.Mesh(new THREE.CircleGeometry(0.3), new THREE.MeshPhongMaterial({
  color: 0x8B4513
}));
leftEar.position.set(-0.7, 0.7, 0);
leftEar.rotation.y = Math.PI / 2;
diddy.add(leftEar);
const rightEar = leftEar.clone();
rightEar.position.set(0.7, 0.7, 0);
diddy.add(rightEar);
const cap = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 0.2), new THREE.MeshPhongMaterial({
  color: 0xFF0000
}));
cap.position.y = 0.8;
diddy.add(cap);
scene.add(diddy);
camera.position.copy(player.position);
const keys = {};
document.addEventListener('keydown', e => {
  keys[e.key.toLowerCase()] = true;
  if (e.key.toLowerCase() === 'f') {
    player.flashlightOn = !player.flashlightOn;
    flashlight.visible = player.flashlightOn;
    diddy.visible = player.flashlightOn;
    document.getElementById('flashlight-state').textContent = `Flashlight: ${player.flashlightOn ? 'true' : 'false'}`;
    const flashlightSound = document.getElementById('flashlight-click-sound');
    flashlightSound.currentTime = 0;
    flashlightSound.volume = 0.5;
    flashlightSound.play().catch(error => console.log("Audio play failed:", error));
  }
});
document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
function updateStaminaBar() {
  document.getElementById('stamina-fill').style.width = player.stamina + '%';
  document.getElementById('stamina-percentage').textContent = Math.round(player.stamina) + '%';
}
function updateBatteryBar() {
  document.getElementById('battery-fill').style.width = player.batteryLevel + '%';
  document.getElementById('battery-percentage').textContent = Math.round(player.batteryLevel) + '%';
}
const minimapRenderer = new THREE.WebGLRenderer({
  alpha: true
});
minimapRenderer.setSize(200, 200);
document.getElementById('minimap').appendChild(minimapRenderer.domElement);
const minimapCamera = new THREE.OrthographicCamera(-75, 75, 75, -75, 1, 1000);
minimapCamera.position.set(0, 100, 0);
minimapCamera.lookAt(0, 0, 0);
function checkCollisions(newX, newZ) {
  const playerPos = new THREE.Vector2(newX, newZ);
  for (const obstacle of obstacles) {
    if (obstacle.type === 'wall') {
      const wallVector = obstacle.end.clone().sub(obstacle.start);
      const playerVector = playerPos.clone().sub(obstacle.start);
      const wallLength = wallVector.length();
      const wallDirection = wallVector.clone().normalize();
      const dot = playerVector.dot(wallDirection);
      const projection = obstacle.start.clone().add(wallDirection.multiplyScalar(dot));
      if (dot >= 0 && dot <= wallLength && playerPos.distanceTo(projection) < 2) {
        return false;
      }
    }
  }
  for (const tree of trees) {
    const treePos = new THREE.Vector2(tree.position.x, tree.position.z);
    if (playerPos.distanceTo(treePos) < 1) {
      return false;
    }
  }
  const distanceFromCenter = Math.sqrt(newX * newX + newZ * newZ);
  if (distanceFromCenter > fenceRadius - 2) {
    return false;
  }
  return true;
}
function animate() {
  requestAnimationFrame(animate);
  if (isPaused) return;
  if (!gameActive || gameOver) return;
  const now = performance.now();
  if (now - lastUpdate > 16) {
    updateGameState();
    lastUpdate = now;
  }
  renderer.render(scene, camera);
}
function updateGameState() {
  if (isPaused) return;
  const diddyAngle = Math.atan2(player.position.x - diddy.position.x, player.position.z - diddy.position.z);
  diddy.rotation.y = diddyAngle;
  flashlight.position.copy(player.position);
  flashlight.target.position.set(player.position.x - Math.sin(camera.rotation.y), player.position.y, player.position.z - Math.cos(camera.rotation.y));
  flashlight.target.updateMatrixWorld();
  const isMoving = keys['w'] || keys['s'] || keys['a'] || keys['d'];
  const walkingSound = document.getElementById('walking-sound');
  if (isMoving) {
    if (walkingSound.paused) {
      walkingSound.volume = 0.5;
      if (keys['shift'] && player.stamina > 0) {
        walkingSound.playbackRate = 2.0;
      } else {
        walkingSound.playbackRate = 1.0;
      }
      walkingSound.play().catch(error => console.log("Audio play failed:", error));
    } else {
      if (keys['shift'] && player.stamina > 0) {
        walkingSound.playbackRate = 2.0;
      } else {
        walkingSound.playbackRate = 1.0;
      }
    }
  } else {
    walkingSound.pause();
  }
  if (!isMoving) {
    player.stamina = Math.min(100, player.stamina + 0.5);
  }
  let currentSpeed;
  if (player.stamina <= 0) {
    currentSpeed = player.exhaustedSpeed;
  } else if (keys['shift'] && player.stamina > 0) {
    currentSpeed = player.sprintSpeed;
    player.stamina = Math.max(0, player.stamina - 0.5);
  } else {
    currentSpeed = player.speed;
  }
  if (keys['w']) {
    const newZ = player.position.z - Math.cos(camera.rotation.y) * currentSpeed;
    const newX = player.position.x - Math.sin(camera.rotation.y) * currentSpeed;
    if (checkCollisions(newX, newZ)) {
      player.position.z = newZ;
      player.position.x = newX;
    }
  }
  if (keys['s']) {
    const newZ = player.position.z + Math.cos(camera.rotation.y) * currentSpeed;
    const newX = player.position.x + Math.sin(camera.rotation.y) * currentSpeed;
    if (checkCollisions(newX, newZ)) {
      player.position.z = newZ;
      player.position.x = newX;
    }
  }
  if (keys['a']) {
    const newX = player.position.x - Math.cos(camera.rotation.y) * currentSpeed;
    const newZ = player.position.z + Math.sin(camera.rotation.y) * currentSpeed;
    if (checkCollisions(newX, newZ)) {
      player.position.x = newX;
      player.position.z = newZ;
    }
  }
  if (keys['d']) {
    const newX = player.position.x + Math.cos(camera.rotation.y) * currentSpeed;
    const newZ = player.position.z - Math.sin(camera.rotation.y) * currentSpeed;
    if (checkCollisions(newX, newZ)) {
      player.position.x = newX;
      player.position.z = newZ;
    }
  }
  batteryPacks.forEach(battery => {
    if (battery.position.distanceTo(player.position) < 2) {
      player.batteryLevel = 100;
      if (player.stamina >= 90) {
        player.stamina = 100;
      } else {
        player.stamina = Math.min(100, player.stamina + 10);
      }
      updateBatteryBar();
      updateStaminaBar();
      const message = document.getElementById('collection-message');
      message.textContent = "Battery Collected!";
      message.className = 'battery-message';
      message.style.transition = 'none';
      message.style.opacity = '1';
      message.offsetHeight;
      message.style.transition = 'opacity 2s';
      setTimeout(() => {
        message.style.opacity = '0';
      }, 100);
      scene.remove(battery);
      batteryPacks.delete(battery);
    }
  });
  if (player.flashlightOn) {
    player.batteryLevel = Math.max(0, player.batteryLevel - 0.1);
    updateBatteryBar();
    if (player.batteryLevel <= 0) {
      player.flashlightOn = false;
      flashlight.visible = false;
      diddy.visible = false;
      document.getElementById('flashlight-state').textContent = `Flashlight: false`;
      const flashlightSound = document.getElementById('flashlight-click-sound');
      flashlightSound.currentTime = 0;
      flashlightSound.volume = 0.5;
      flashlightSound.play().catch(error => console.log("Audio play failed:", error));
    }
  }
  const baseSpeed = isEvilMode ? evilBaseSpeed : normalBaseSpeed;
  const speedIncrease = isEvilMode ? 0.012 : 0.008;
  const flashlightSpeedMultiplier = player.flashlightOn ? 1.0 : 1.2;
  const practiceSpeedMultiplier = isPracticeMode ? 0.25 : 1.0;
  const currentDiddySpeed = (baseSpeed + speedIncrease * lotionsCollected) * flashlightSpeedMultiplier * practiceSpeedMultiplier;
  const diddyDirection = new THREE.Vector3();
  diddyDirection.subVectors(player.position, diddy.position).normalize();
  diddy.position.add(diddyDirection.multiplyScalar(currentDiddySpeed));
  updateStaminaBar();
  updateBatteryBar();
  camera.position.copy(player.position);
  updateTerrain();
  if (!useMouseLook) {
    if (keys['arrowleft']) camera.rotation.y += arrowKeyRotationSpeed;
    if (keys['arrowright']) camera.rotation.y -= arrowKeyRotationSpeed;
  }
  if (frameCount % 3 === 0) {
    updateMinimap();
  }
  frameCount++;
  lotions.forEach(lotion => {
    if (lotion.position.distanceTo(player.position) < 2) {
      scene.remove(lotion);
      lotions.delete(lotion);
      lotionsCollected++;
      if (player.stamina < 50) {
        player.stamina = Math.min(100, player.stamina + 50);
      } else {
        player.stamina = 100;
      }
      if (player.batteryLevel >= 95) {
        player.batteryLevel = 100;
      } else {
        player.batteryLevel = Math.min(100, player.batteryLevel + 5);
      }
      updateStaminaBar();
      updateBatteryBar();
      document.getElementById('lotion-counter').textContent = `Baby Oil: ${lotionsCollected}/26`;
      const message = document.getElementById('collection-message');
      message.textContent = "Baby Oil Collected!";
      message.className = 'oil-message';
      message.style.transition = 'none';
      message.style.opacity = '1';
      message.offsetHeight;
      message.style.transition = 'opacity 2s';
      setTimeout(() => {
        message.style.opacity = '0';
      }, 100);
      if (lotionsCollected >= 26) {
        showVictory();
      }
    }
  });
  if (diddy.position.distanceTo(player.position) < 2) {
    showGameOver();
  }
  distanceToDiddy = diddy.position.distanceTo(player.position);
  const normalizedDistance = Math.max(0, Math.min(1, 1 - distanceToDiddy / 50));
  const maxVolume = 0.5;
  chaseMusic.volume = normalizedDistance * maxVolume;
  diddyLight.intensity = normalizedDistance;
  document.getElementById('static-overlay').style.opacity = normalizedDistance * 0.7;
}
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
document.addEventListener('keydown', handlePause);
function handlePause(event) {
  if (event.key.toLowerCase() === 'q') {
    togglePause();
  }
}
function togglePause() {
  if (!gameActive || gameOver) return;
  isPaused = !isPaused;
  const walkingSound = document.getElementById('walking-sound');
  if (isPaused) {
    document.getElementById('pause-menu').style.display = 'flex';
    chaseMusic.pause();
    walkingSound.pause();
    walkingSound.playbackRate = 1.0;
    if (document.exitPointerLock) {
      try {
        document.exitPointerLock();
      } catch (error) {
        console.log("Error exiting pointer lock on pause:", error);
      }
    }
  } else {
    document.getElementById('pause-menu').style.display = 'none';
    if (gameActive) {
      chaseMusic.play().catch(error => console.log("Audio play failed:", error));
      if (keys['w'] || keys['s'] || keys['a'] || keys['d']) {
        walkingSound.play().catch(error => console.log("Audio play failed:", error));
      }
    }
  }
}
const menuTheme = document.getElementById('menu-theme');
window.addEventListener('load', () => {
  document.querySelector('.loading').style.display = 'flex';
  setTimeout(() => {
    const loadingText = document.querySelector('.loading').childNodes[0];
    loadingText.textContent = 'Loading Complete.';
    const loadingBtn = document.getElementById('loading-complete-btn');
    loadingBtn.style.display = 'block';
    loadingBtn.addEventListener('click', () => {
      document.querySelector('.loading').style.display = 'none';
      menuTheme.loop = true;
      menuTheme.play().catch(() => {
        document.addEventListener('click', () => {
          menuTheme.play();
        }, {
          once: true
        });
      });
    });
  }, 2000);
});
function showGameOver() {
  gameOver = true;
  gameActive = false;
  document.getElementById('game-over').style.display = 'flex';
  const walkingSound = document.getElementById('walking-sound');
  walkingSound.pause();
  chaseMusic.pause();
  menuTheme.pause();
  menuTheme.currentTime = 0;
  const jumpscareSound = document.getElementById('jumpscare-sound');
  jumpscareSound.currentTime = 0;
  jumpscareSound.volume = 0.25;
  jumpscareSound.play().catch(error => console.log("Audio play failed:", error));
  const overlay = document.getElementById('jumpscare-overlay');
  overlay.style.transition = 'none';
  overlay.style.opacity = '1';
  overlay.offsetHeight;
  overlay.style.transition = 'opacity 3s';
  setTimeout(() => {
    overlay.style.opacity = '0';
  }, 100);
}
function showVictory() {
  gameOver = true;
  gameActive = false;
  document.getElementById('victory-screen').style.display = 'flex';
  const victoryTitle = document.getElementById('victory-screen').querySelector('h1');
  const victoryText = document.getElementById('victory-screen').querySelector('p');
  if (isPracticeMode) {
    victoryTitle.textContent = 'Practice Complete!';
    victoryText.textContent = "CONGRATULATIONS ON COMPLETING THE PRACTICE MODE! now complete the normal mode";
  } else {
    victoryTitle.textContent = 'Victory!';
    victoryText.textContent = "You've collected all the baby oil and escaped Diddy!";
  }
  const walkingSound = document.getElementById('walking-sound');
  walkingSound.pause();
  chaseMusic.pause();
  menuTheme.volume = 0.8;
  menuTheme.play().catch(error => console.log("Audio play failed:", error));
}
function playButtonClickSound() {
  const buttonSound = document.getElementById('button-click-sound');
  buttonSound.currentTime = 0;
  buttonSound.volume = 0.25;
  buttonSound.play();
}
function showTitleMenu() {
  gameOver = true;
  gameActive = false;
  document.getElementById('game-over').style.display = 'none';
  document.getElementById('victory-screen').style.display = 'none';
  document.getElementById('pause-menu').style.display = 'none';
  document.getElementById('settings-menu').style.display = 'none';
  document.getElementById('tutorial-menu').style.display = 'none';
  document.getElementById('difficulty-menu').style.display = 'none';
  document.getElementById('start-menu').style.display = 'flex';
  const walkingSound = document.getElementById('walking-sound');
  walkingSound.pause();
  chaseMusic.pause();
  menuTheme.volume = 0.8;
  menuTheme.play().catch(error => console.log("Audio play failed:", error));
  document.body.classList.remove('evil-mode');
  document.getElementById('game-container').classList.remove('practice-mode-lighting');
}
function closeSettings() {
  document.getElementById('settings-menu').style.display = 'none';
  document.getElementById('start-menu').style.display = 'flex';
  localStorage.setItem('useMouseLook', useMouseLook);
  jumpscareEnabled = document.getElementById('enable-jumpscare').checked;
  if (jumpscareEnabled) {
    const overlay = document.getElementById('jumpscare-overlay');
    const jumpscareSound = document.getElementById('jumpscare-sound');
    overlay.style.transition = 'none';
    overlay.style.opacity = '1';
    jumpscareSound.currentTime = 0;
    jumpscareSound.volume = 0.25;
    jumpscareSound.play().catch(error => console.log("Audio play failed:", error));
    setTimeout(() => {
      overlay.style.transition = 'opacity 3s';
      overlay.style.opacity = '0';
      jumpscareEnabled = false;
      document.getElementById('enable-jumpscare').checked = false;
    }, 100);
  }
}
function showSettings() {
  document.getElementById('start-menu').style.display = 'none';
  document.getElementById('settings-menu').style.display = 'flex';
  const savedMouseLook = localStorage.getItem('useMouseLook') === 'true';
  document.getElementById('use-mouse-look').checked = savedMouseLook;
  toggleMouseLook(savedMouseLook);
  document.getElementById('enable-jumpscare').checked = jumpscareEnabled;
}
function showTutorial() {
  document.getElementById('start-menu').style.display = 'none';
  document.getElementById('tutorial-menu').style.display = 'flex';
}
function closeTutorial() {
  document.getElementById('tutorial-menu').style.display = 'none';
  document.getElementById('start-menu').style.display = 'flex';
}
function showDifficultyMenu() {
  document.getElementById('start-menu').style.display = 'none';
  document.getElementById('difficulty-menu').style.display = 'flex';
}
let useMouseLook = false;
let isPointerLocked = false;
function toggleMouseLook(enabled) {
  useMouseLook = enabled;
  if (enabled) {
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('click', requestPointerLock);
  } else {
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('click', requestPointerLock);
    if (document.exitPointerLock) {
      try {
        document.exitPointerLock();
      } catch (error) {
        console.log("Error exiting pointer lock:", error);
      }
    }
  }
  updateControlsDisplay();
}
function requestPointerLock() {
  if (!isPointerLocked && useMouseLook && gameActive && !isPaused) {
    try {
      renderer.domElement.requestPointerLock().catch(err => {
        console.log("Pointer lock request failed:", err);
      });
    } catch (error) {
      console.log("Error requesting pointer lock:", error);
    }
  }
}
function handleMouseMove(event) {
  if (useMouseLook && gameActive && !isPaused && document.pointerLockElement) {
    try {
      camera.rotation.y -= event.movementX * mouseSensitivity;
    } catch (error) {
      console.log("Mouse movement error:", error);
    }
  }
}
document.addEventListener('pointerlockchange', () => {
  try {
    isPointerLocked = document.pointerLockElement !== null;
  } catch (error) {
    console.log("Pointer lock state change error:", error);
    isPointerLocked = false;
  }
});
function updateControlsDisplay() {
  const controls = document.getElementById('controls');
  if (useMouseLook) {
    controls.innerHTML = `
                    Controls:<br>
                    WASD - Move<br>
                    Shift - Sprint<br>
                    Mouse - Look Around<br>
                    F - Toggle Flashlight
                `;
  } else {
    controls.innerHTML = `
                    Controls:<br>
                    WASD - Move<br>
                    Shift - Sprint<br>
                    &#x2190;&#x2192; - Rotate Camera<br>
                    F - Toggle Flashlight
                `;
  }
}
let jumpscareEnabled = false;
animate();</script>
</body>
</html>
